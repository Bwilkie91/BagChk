e.filter = 'none';
                            }
                        });
                        $('#distance-info').textContent = `Nearest location: ${sanitizeInput(nearest.name)} (${(minDist / 1000).toFixed(2)} km away)`;
                    }
                    $('#map-loading').style.display = 'none';
                    $('#find-location').disabled = false;
                },
                err => {
                    clearTimeout(timeoutId);
                    $('#map-loading').style.display = 'none';
                    $('#find-location').disabled = false;
                    const messages = {
                        1: 'Location access denied. Enable permissions or select manually.',
                        2: 'Location unavailable. Try again or select manually.',
                        3: 'Location timed out. Try again or select manually.'
                    };
                    alert(messages[err.code] || 'Error retrieving location. Select manually.');
                    console.error('Geolocation error:', err);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) ** 2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        };

        form.addEventListener('submit', e => {
            e.preventDefault();
            const submitBtn = $('#book-now');
            if (['personal', 'storage', 'preferences'].every(step => validateStep(step, true))) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                submitBtn.classList.remove('pulse');
                setTimeout(() => {
                    const details = Object.fromEntries(
                        Object.entries(inputs).map(([k, i]) => [k, i.type === 'checkbox' ? i.checked : sanitizeInput(i.value)])
                    );
                    $('#modal-details').innerHTML = Object.entries(details)
                        .filter(([, v]) => v)
                        .map(([k, v]) => `<p><strong>${sanitizeInput(k.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase()))}:</strong> ${k.includes('Date') ? new Date(v).toLocaleString('en-US', { timeZone: 'America/Chicago' }) : sanitizeInput(v.toString())}</p>`)
                        .join('');
                    $('#qrcode').innerHTML = '';
                    new QRCode($('#qrcode'), { 
                        text: JSON.stringify(details), 
                        width: Math.min(window.innerWidth * 0.8, 200),
                        height: Math.min(window.innerWidth * 0.8, 200),
                        colorDark: '#000', 
                        colorLight: '#fff', 
                        correctLevel: QRCode.CorrectLevel.H 
                    });
                    $('#confirmation-modal').style.display = 'flex';
                    $('#confirmation-modal').focus();
                    triggerConfetti();
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Confirm Booking';
                    submitBtn.classList.add('pulse');
                }, 1000);
            } else {
                const firstInvalidStep = ['personal', 'storage', 'preferences'].find(step => !validateStep(step, true));
                if (firstInvalidStep) {
                    switchStep(firstInvalidStep);
                    const firstInvalidInput = $(`.form-section[data-step="${firstInvalidStep}"] input[aria-invalid="true"], .form-section[data-step="${firstInvalidStep}"] select[aria-invalid="true"]`);
                    if (firstInvalidInput) firstInvalidInput.focus();
                }
            }
        });

        $('#download-qr').addEventListener('click', () => {
            const c = $('#qrcode canvas');
            if (c) {
                const a = document.createElement('a');
                a.href = c.toDataURL('image/png');
                a.download = 'bagchk-receipt-qr.png';
                a.click();
            }
        });
        $('#add-to-calendar').addEventListener('click', () => {
            const ics = [
                'BEGIN:VCALENDAR', 
                'VERSION:2.0', 
                'BEGIN:VEVENT',
                `DTSTART:${new Date(inputs.startDate.value).toISOString().replace(/[-:]/g, '').split('.')[0]}Z`,
                `DTEND:${new Date(inputs.endDate.value).toISOString().replace(/[-:]/g, '').split('.')[0]}Z`,
                'SUMMARY:Bagchk Luggage Storage', 
                `DESCRIPTION:Storage at ${sanitizeInput(inputs.location.value)}`, 
                `LOCATION:${sanitizeInput(inputs.location.value)}`,
                'END:VEVENT', 
                'END:VCALENDAR'
            ].join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([ics], { type: 'text/calendar' }));
            a.download = 'bagchk-booking.ics';
            a.click();
        });
        $('#modal-close').addEventListener('click', () => {
            $('#confirmation-modal').style.display = 'none';
            resetForm();
            triggerConfetti();
            $('#book').scrollIntoView({ behavior: 'smooth' });
        });

        const triggerConfetti = () => {
            const count = window.innerWidth <= 640 ? 30 : 50;
            for (let i = 0; i < count; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = `${Math.random() * 100}vw`;
                c.style.background = ['var(--primary)', '#10b981', '#f59e0b'][Math.floor(Math.random() * 3)];
                c.style.animationDelay = `${Math.random() * 0.5}s`;
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 2000);
            }
        };

        const resetForm = () => {
            Object.values(inputs).forEach(i => {
                if (i.type === 'checkbox') {
                    i.checked = false;
                } else {
                    i.value = i.tagName === 'SELECT' ? '' : '';
                }
                i.classList.remove('error', 'valid');
                const errorEl = $(`#${toKebabCase(i.id)}-error`);
                if (errorEl) {
                    errorEl.classList.remove('show');
                    errorEl.textContent = '';
                }
            });
            inputs.startDate.min = inputs.startDate.value = getNextHourInCDT();
            inputs.endDate.value = getDefaultEndDate(inputs.startDate.value);
            $$('.form-section').forEach(s => {
                s.classList.toggle('active', s.dataset.step === 'personal');
                s.setAttribute('aria-hidden', s.dataset.step !== 'personal');
            });
            $$('.progress-step').forEach(s => {
                s.classList.toggle('active', s.dataset.step === 'personal');
                s.classList.remove('completed');
                s.setAttribute('aria-current', s.dataset.step === 'personal' ? 'step' : 'false');
            });
            currentStep = 'personal';
            $('.progress-bar').setAttribute('aria-valuenow', 1);
            validationCache.clear();
            updateSummary();
            updateProgress();
            if (userMarker) map.removeLayer(userMarker);
            userMarker = null;
            if (watchId) navigator.geolocation.clearWatch(watchId);
            watchId = null;
            Object.keys(localStorage).filter(k => k.startsWith('bagchk_')).forEach(k => localStorage.removeItem(k));
            $('#distance-info').textContent = '';
            inputs.location.dispatchEvent(new Event('change'));
        };
        $('#reset-form').addEventListener('click', resetForm);

        $$('input, select, button, textarea').forEach(el => el.addEventListener('keydown', e => {
            if (e.key === 'Enter' && el.tagName !== 'BUTTON' && el.tagName !== 'TEXTAREA') {
                e.preventDefault();
                const all = $$('input, select, textarea, button');
                const currentSection = $(`.form-section.active`);
                const next = all.find((i, idx) => idx > all.indexOf(el) && currentSection.contains(i));
                if (next) next.focus();
            }
        }));
        $('#map').addEventListener('keydown', e => {
            e.preventDefault();
            const d = innerWidth <= 640 ? 20 : 50;
            const moves = { ArrowUp: [0, -d], ArrowDown: [0, d], ArrowLeft: [-d, 0], ArrowRight: [d, 0] };
            if (moves[e.key]) map.panBy(moves[e.key], { animate: true });
            if (['+', '='].includes(e.key)) map.zoomIn();
            if (['-', '_'].includes(e.key)) map.zoomOut();
        });

        let resizeT;
        window.addEventListener('resize', () => {
            clearTimeout(resizeT);
            resizeT = setTimeout(() => {
                map.invalidateSize();
                const z = innerWidth <= 640 ? 10 : 13;
                if (map.getZoom() !== z) map.setZoom(z);
            }, 200);
        });

        const initializeForm = () => {
            inputs.startDate.value = getNextHourInCDT();
            inputs.startDate.min = inputs.startDate.value;
            inputs.endDate.value = getDefaultEndDate(inputs.startDate.value);
            inputs.bagCount.value = inputs.bagCount.value || '1';
            inputs.bagType.value = inputs.bagType.value || 'standard';
            inputs.location.value = inputs.location.value || 'Downtown Storage - Michigan Ave';

            Object.values(inputs).forEach(i => {
                const saved = localStorage.getItem(`bagchk_${i.id}`);
                if (saved !== null) {
                    if (i.type === 'checkbox') {
                        i.checked = saved === 'true';
                    } else {
                        i.value = saved;
                    }
                }
            });

            validateStep(currentStep, true);
            inputs.location.dispatchEvent(new Event('change'));
            updateSummary();
            updateProgress();
        };

        inputs.startDate.addEventListener('change', () => {
            if (!inputs.endDate.value || new Date(inputs.endDate.value) <= new Date(inputs.startDate.value)) {
                inputs.endDate.value = getDefaultEndDate(inputs.startDate.value);
            }
            validateStep(currentStep, true);
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (document.body) {
                initializeForm();
            } else {
                console.error('DOM not ready for initialization');
            }
        });
    </script>
</body>
</html>
